name: Deploy SentinelX to Cloud Run

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: string

env:
  APP_NAME: sentinelx
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  ARTIFACT_REGISTRY_REPO: ${{ vars.ARTIFACT_REGISTRY_REPO || 'sentinelx-docker-repo' }}

jobs:
  build-and-deploy:
    name: Build and Deploy SentinelX
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x apps/sentinelx/gradlew
        working-directory: .

      - name: Build with Gradle
        run: ./gradlew clean build --no-daemon
        working-directory: apps/sentinelx

      - name: Run tests
        run: ./gradlew test --no-daemon
        working-directory: apps/sentinelx

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and tag Docker image
        run: |
          IMAGE_TAG="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.APP_NAME }}:${{ github.sha }}"
          IMAGE_TAG_LATEST="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.APP_NAME }}:latest"
          
          docker build \
            -t $IMAGE_TAG \
            -t $IMAGE_TAG_LATEST \
            -f apps/sentinelx/Dockerfile \
            apps/sentinelx
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_TAG_LATEST=$IMAGE_TAG_LATEST" >> $GITHUB_ENV

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_TAG_LATEST }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ vars.SENTINELX_SERVICE_NAME || 'sentinelx-service' }} \
            --image=${{ env.IMAGE_TAG }} \
            --platform=managed \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --port=8081 \
            --memory=${{ vars.SENTINELX_MEMORY || '512Mi' }} \
            --cpu=${{ vars.SENTINELX_CPU || '1' }} \
            --min-instances=${{ vars.SENTINELX_MIN_INSTANCES || '0' }} \
            --max-instances=${{ vars.SENTINELX_MAX_INSTANCES || '10' }} \
            --timeout=${{ vars.SENTINELX_TIMEOUT || '600' }} \
            --service-account=github-actions@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --set-env-vars="SPRING_PROFILES_ACTIVE=dev" \
            --set-env-vars="SPRING_CLOUD_GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" \
            --project=${{ env.GCP_PROJECT_ID }}

      - name: Get Cloud Run service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ vars.SENTINELX_SERVICE_NAME || 'sentinelx-service' }} \
            --platform=managed \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)' \
            --project=${{ env.GCP_PROJECT_ID }})
          echo "Service URL: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Application:** SentinelX" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** prod" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Service URL:** ${{ env.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
